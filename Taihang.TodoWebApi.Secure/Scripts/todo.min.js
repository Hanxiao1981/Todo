var headers = {}; var token = sessionStorage.getItem('tokenKey'); if (token) { headers.Authorization = 'Bearer ' + token } else { location.href = "login.html" }; var uri = 'api/Todo'; var pattern = "addPattern"; var todoViewModel = { todoList: [], pageSize: 10, pageNumber: 1, pageCount: 1 }; var layer = null; $(function () { $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) { pattern = e.target.id; }); $('#btnAdd').on('click', addTodo); $('#btnSearch').on('click', searchTodo); var vmTodoList = new Vue({ el: "#todoListVM", data: todoViewModel }); var vmPageNav = new Vue({ el: '#pageNavVM', data: todoViewModel }); layui.use('layer', function () { layer = layui.layer; loadTodoList(1, todoViewModel.pageSize) }) }); function loadTodoList(number, size) { var search = ""; if (pattern == "searchPattern") { search = $("#txtSearch").val() }; var index = layer.load(2); $.ajax({ type: "GET", url: uri, headers: headers, data: { searchKey: search, pageNumber: number, pageSize: size }, dataType: 'json', success: function (data) { layer.close(index); todoViewModel.pageCount = data.PageCount; todoViewModel.pageNumber = data.PageNumber; todoViewModel.todoList = data.PageData } }) }; function generatePageList() { var pageList = ""; if (todoViewModel.pageCount <= 10) { for (var page = 1; page <= todoViewModel.pageCount; page++) { pageList += generatePage(page) } } else { if (todoViewModel.pageNumber <= 5) { for (var page = 1; page <= 5; page++) { pageList += generatePage(page) }; pageList += '<li><span onclick="navTo(6)">...</span></li>'; pageList += '<li><span onclick="navTo(' + todoViewModel.pageCount + ')">尾页</span></li>' } else if (todoViewModel.pageNumber > todoViewModel.pageCount - 5) { pageList += '<li><span onclick="navTo(1)">首页</span></li>'; pageList += '<li><span onclick="navTo(' + (todoViewModel.pageCount - 5) + ')">...</span></li>'; for (var page = todoViewModel.pageCount - 4; page <= todoViewModel.pageCount; page++) { pageList += generatePage(page) } } else { pageList += '<li><span onclick="navTo(1)">首页</span></li>'; pageList += '<li><span onclick="navTo(' + (todoViewModel.pageNumber - 3) + ')">...</span></li>'; for (var page = todoViewModel.pageNumber - 2; page <= todoViewModel.pageNumber + 2; page++) { pageList += generatePage(page) }; pageList += '<li><span onclick="navTo(' + (todoViewModel.pageNumber + 3) + ')">...</span></li>'; pageList += '<li><span onclick="navTo(' + todoViewModel.pageCount + ')">尾页</span></li>' } }; return pageList }; function generatePage(page) { if (page == todoViewModel.pageNumber) { return '<li class="active"><span>' + page + '</span></li>' } else { return '<li><span onclick="navTo(' + page + ')">' + page + '</span></li>' } }; function navTo(pageNumber) { loadTodoList(pageNumber, todoViewModel.pageSize) }; function searchTodo() { loadTodoList(1, todoViewModel.pageSize) }; function addTodo() { var name = $("#txtAdd").val(); $.ajax({ type: "POST", url: uri, headers: headers, data: { Name: name }, success: function (data) { loadTodoList(1, todoViewModel.pageSize); $("#txtAdd").val(""); alert("添加成功") } }) }; function editTodo(todo) { layer.dialogModel = { ID: todo.ID, Name: todo.Name, Completed: todo.Completed }; layer.open({ title: '更新任务', type: 2, content: 'todoDialog.html', btn: ['确定', '取消'], yes: function (index, layero) { layer.close(index); $.ajax({ type: "PUT", url: uri, headers: headers, data: JSON.stringify(layer.dialogModel), contentType: 'application/json; charset=utf-8', success: function (data) { todo.Name = layer.dialogModel.Name; todo.Completed = layer.dialogModel.Completed; alert("更新完成") } }) } }) }; function delTodo(todo) { layer.confirm('你确定要删除该任务吗?', function (index) { layer.close(index); $.ajax({ type: "DELETE", url: uri + "/" + todo.ID, headers: headers, success: function (data) { loadTodoList(todoViewModel.pageNumber, todoViewModel.pageSize); alert("删除成功") } }) }) }